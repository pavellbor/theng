import { Injectable } from '@nestjs/common';
import { CEFRLevel } from '@prisma/client';
import { OpenAIService } from 'src/infrastructure/openai/openai.service';

interface CheckTranslationParams {
  russianTranslation: string;
  englishSentence: string;
  userTranslation: string;
  word: string;
  grammarTopicName: string;
  cefrLevel: CEFRLevel;
}

@Injectable()
export class TranslationCheckService {
  constructor(private openAIService: OpenAIService) {}

  async checkTranslation(params: CheckTranslationParams) {
    const originalRussianSentence = params.russianTranslation;
    const correctAnswer = params.englishSentence;
    const userTranslation = params.userTranslation;
    const sentenceWord = params.word;
    const sentenceGrammarTopicName = params.grammarTopicName;
    const cefrLevel = params.cefrLevel;

    const prompt = `Оцени, пожалуйста, качество перевода на английский язык и дай **краткую и понятную обратную связь на русском языке** в упрощенном формате, фокусируясь на ключевых аспектах: **правильности использования слова, грамматической темы и общей верности перевода с учетом стилистической уместности и естественности.**  **Важно: Все оценки должны проводиться с учетом уровня CEFR предложения: ${cefrLevel}, но *не делай излишний акцент на уровне в самом тексте фидбека, фокусируйся на общих принципах стилистической уместности и естественности*.**

                      **Оригинальное русское предложение:**
                      \`\`\`
                      ${originalRussianSentence}
                      \`\`\`

                      **Эталонный перевод на английский (Present Simple):**
                      \`\`\`
                      ${correctAnswer}
                      \`\`\`

                      **Перевод пользователя:**
                      \`\`\`
                      ${userTranslation}
                      \`\`\`

                      **Ключевое слово в предложении (для проверки словарного запаса):**
                      \`\`\`
                      ${sentenceWord}
                      \`\`\`

                      **Грамматическая тема предложения (для проверки грамматики):**
                      \`\`\`
                      ${sentenceGrammarTopicName}
                      \`\`\`

                      **Инструкции для оценки (ответ на русском языке,  максимально четкое разграничение областей оценки):**

                      1. **Правильность использования ключевого слова (word):**  Оцени **исключительно правильность *самого ключевого слова* "${sentenceWord}"**: его **написание, грамматическую форму и уместность *в самом общем смысле* (часть речи, базовое значение)**.  **Важно:  Не оценивай здесь *общую семантическую верность всего предложения* - это задача раздела \`overall\`.**  Раздел \`word\` фокусируется **только на ключевом слове как таковом.**   В поле \`word.isCorrect\` укажи верность использования ключевого слова (**true** - верно / **false** - неверно).  В \`word.feedback\` дай **краткий комментарий на русском языке**, похвали за верное использование или укажи на ошибку в **форме или базовом значении *самого слова***, ориентируясь на **лексическую точность и уместность *именно ключевого слова***, *без привязки к уровню CEFR и не затрагивая оценку общего смысла предложения*.

                      2. **Правильность применения грамматической темы (grammarTopic):**  Оцени **исключительно грамматическую корректность предложения *в рамках заданной грамматической темы* "${sentenceGrammarTopicName}"**.  **Важно: Оценивай только, *грамматически правильно ли применена тема*,  *независимо от общей стилистической уместности или семантической верности *всего предложения* (это оценивается в \`overall\`).** Раздел \`grammarTopic\` фокусируется **только на грамматической правильности *применения заданной темы*,  как таковой.**  Даже если предложение в целом стилистически или семантически неудачно, но грамматическая тема применена *верно с грамматической точки зрения*,  оценка в \`grammarTopic.isCorrect\` должна быть **true**.  Стилистическая уместность темы *в контексте предложения* и общая семантическая адекватность  оцениваются в разделе \`overall\`.  В поле \`grammarTopic.isCorrect\` укажи, **грамматически верно или нет** применена тема (**true** - верно / **false** - неверно).  В \`grammarTopic.feedback\` дай **краткое объяснение на русском языке**,  указывая на грамматическую правильность или ошибку **именно в контексте заданной грамматической темы**, с четкими пояснениями и примерами, *без акцента на уровне CEFR и не затрагивая оценку общего смысла предложения*.

                      3. **Общая оценка перевода (overall):**  Оцени **общую семантическую верность, стилистическую уместность и естественность** перевода пользователя, **учитывая *все аспекты* перевода в комплексе:  полную и адекватную передачу смысла оригинального русского предложения, грамматическую корректность *всего предложения* (включая грамматику и лексику за пределами ключевого слова и грамматической темы), лексическую точность *всех слов в предложении*, беглость и естественность звучания, а также стилистическую адекватность всего перевода в целом.**  **Раздел \`overall\`  является *интегральной оценкой всего перевода как целого*,  где *ключевыми критериями являются семантическая точность, стилистическая уместность и естественность звучания на английском языке*.**   В поле \`overall.isCorrect\` дай **общую оценку верности перевода** (**true** - верен и стилистически уместен / **false** - не верен или стилистически заметно не уместен). В \`overall.feedback\` дай **развернутый итоговый комментарий на русском языке**, объясняющий общую оценку,  суммируя как общие сильные и слабые стороны перевода *по всем аспектам*, так и **детальные рекомендации по дальнейшему улучшению семантической точности, стилистической уместности и естественности, и общей грамматической и лексической корректности *всего перевода в целом*.**  **Включай в \`overall.feedback\` все замечания и рекомендации, касающиеся *общего качества перевода*,  выходящие за рамки оценки только ключевого слова и грамматической темы. В случаях семантических неточностей, стилистической неоптимальности или грамматических/лексических ошибок *в любой части предложения*,  объясни, как исправить перевод и сделать его более семантически точным, стилистически естественным и грамматически корректным, *без привязки к уровню CEFR, фокусируясь на общих принципах хорошего стиля и точной передачи смысла*.**

                      **Примеры некорректного использования для иллюстрации (чтобы лучше понять, как оценивать, в ответах ждем JSON):**

                      * **Грамматическая тема: "How much/many + noun",  пример с ошибкой (грамматическая ошибка в рамках темы):**  "How much apples you want?".  =>  \`grammarTopic.isCorrect: false\`.  \`grammarTopic.feedback\`: "**Ошибка в использовании 'much' с исчисляемыми. Нужно 'many' – это грамматическая ошибка в теме 'How much/many'.**" *(четкий фокус на грамматической ошибке в рамках темы)*

                      * **Ключевое слово: "cook" (глагол), пример с ошибкой (неверная форма слова):** "He is a good cooker." => \`word.isCorrect: false\`.  \`word.feedback\`: "**Неверная форма ключевого слова 'cooker'.  Нужно 'cook' (повар) или 'cook' (глагол готовить). 'Cooker' – это плита. Ошибка в выборе формы ключевого слова.**" *(четкий фокус на форме и базовом значении ключевого слова)*

                      * **Местоимение: "She/He", *пример, критически влияющий на общий смысл и стилистическую адекватность*:** "Она - учитель." => Перевод пользователя: "He is a teacher." => \`overall.isCorrect: false\`. \`word.isCorrect: true\`. \`grammarTopic.isCorrect: true\`. \`overall.feedback\`: "**Перевод *семантически неверен* из-за критической ошибки с местоимением 'He' вместо 'She', *полностью искажающей смысл*.  Ошибка выходит за рамки ключевого слова и грамматической темы и затрагивает *общую семантическую адекватность всего перевода*.  В целом, уделите особое внимание местоимениям и *общей семантической точности перевода*.**" *(раздел overall фокусируется на общей семантической ошибке, выходящей за рамки слова и грамматической темы)*

                      * **Выбор времени: Present Simple vs Present Continuous, *пример стилистической неоптимальности*,  тема оценивается как стилистически неверная, общая оценка - тоже как false, из-за стилистической неадекватности всего перевода:**  "Я вижу собаку (прямо сейчас)." => Перевод пользователя: "I am seeing a dog." => \`overall.isCorrect: false\`. \`word.isCorrect: true\`. \`grammarTopic.isCorrect: false\`. \`grammarTopic.feedback\`: "**Стилистически неуместно использовать Present Continuous для простого описания восприятия *в рамках грамматической темы 'Present Simple vs Present Continuous'*.  В данном контексте, в рамках этой темы,  Present Simple ('I see') является стилистически верным выбором.**" *(раздел grammarTopic фокусируется на стилистической уместности *в рамках грамматической темы*)* \`overall.feedback\`: "**Перевод *стилистически неверен* из-за *общей стилистической неадекватности* использования Present Continuous в простом описании восприятия. Для *естественного и стилистически корректного звучания всего перевода* лучше использовать Present Simple ('I see').  В целом,  старайтесь всегда оценивать *общую стилистическую уместность и естественность всего перевода*, и выбирать наиболее *стилистически адекватные* варианты для *выражения общей мысли на английском языке*." *(раздел overall фокусируется на общей стилистической неадекватности *всего перевода*)*

                      * **Прилагательное "hard" vs "heavy" (пример из предыдущего вопроса):** "Эта сумка тяжёлая." => Перевод пользователя: "This bag is hard." =>  \`overall.isCorrect: false\`. \`word.isCorrect: true\`. \`grammarTopic.isCorrect: true\`. \`overall.feedback\`: "**Перевод *семантически неверен*, так как прилагательное 'hard' имеет *неверное значение в контексте веса*. 'Hard' означает 'твердый' или 'трудный', а не 'тяжелый' в плане веса.  Для *семантически точного перевода* нужно использовать прилагательное 'heavy' ('тяжелый по весу').  Ошибка в выборе *лексики за пределами ключевого слова и грамматической темы*  приводит к *общей семантической неадекватности всего перевода*. В целом, будьте внимательны к *точному выбору слов во всем предложении*, чтобы *полностью и адекватно передавать смысл оригинала*.**" *(раздел overall фокусируется на общей семантической неверности из-за лексической ошибки *вне ключевого слова и грамматической темы*, влияющей на *весь перевод*)*


                      **Формат ответа:**
                      Пожалуйста, верни ответ в формате JSON.  JSON должен содержать следующие поля:

                      \`\`\`json
                      {
                        "word": {
                          "isCorrect": boolean,
                          "feedback": string // <----  ФИДБЕК НА РУССКОМ (только о ключевом слове)
                        },
                        "grammarTopic": {
                          "isCorrect": boolean,
                          "feedback": string // <----  ФИДБЕК НА РУССКОМ (только о грамматической теме)
                        },
                        "overall": {
                          "isCorrect": boolean, //  <----  ТЕПЕРЬ ТОЛЬКО BOOLEAN (true/false)
                          "feedback": string // <----  ОБЪЕДИНЕННЫЙ ОБЩИЙ ФИДБЕК-РЕЗЮМЕ И РЕКОМЕНДАЦИИ НА РУССКОМ (о всем переводе в целом)
                        }
                      }
                      \`\`\`
    `;

    return this.openAIService.createChatCompletion<{
      overall: {
        isCorrect: boolean;
        feedback: string;
      };
      word: {
        isCorrect: boolean;
        feedback: string;
      };
      grammarTopic: {
        isCorrect: boolean;
        feedback: string;
      };
    }>(prompt);
  }
}
