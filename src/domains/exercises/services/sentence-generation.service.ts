import { Injectable } from '@nestjs/common';
import { OpenAIService } from 'src/infrastructure/openai/openai.service';

interface GenerateSentenceParams {
  word: string;
  partOfSpeech: string;
  russianTranslation: string;
  grammarTopic: string;
  cefrLevel: string;
}

@Injectable()
export class SentenceGenerationService {
  constructor(private openAIService: OpenAIService) {}

  async generateSentence(params: GenerateSentenceParams) {
    const { word, partOfSpeech, russianTranslation, grammarTopic, cefrLevel } =
      params;

    const prompt = `генерируй, пожалуйста, **простое и понятное** английское предложение, **которое звучит как пример реального использования языка**, используя слово "${word}".

                        **Основная цель:** **Показать пример использования слова "${word}" и грамматической темы "${grammarTopic}" в естественном, реальном предложении.**

                        **Ключевые требования к предложению:**

                        1. **Пример реального использования:**
                          - Предложение должно звучать как **фрагмент реальной речи или текста**, который мог бы быть произнесен или написан **носителем английского языка в повседневной ситуации**.
                          - **Представьте себе реальную ситуацию**, где такое предложение могло бы быть уместно.
                          - Избегайте **неестественных, искусственных или слишком учебных** формулировок.

                        2. **Грамматическая тема раскрыта через пример:**
                          - Предложение должно **естественно демонстрировать** грамматическую тему "${grammarTopic}" **через пример использования**.
                          - Грамматическая тема должна быть **органично вплетена в предложение**, как это происходит в реальной речи, а не выделяться излишне искусственно.
                          - Цель - показать **как грамматика работает в реальном предложении**, а не просто проиллюстрировать правило.

                        3. **Соответствие уровню CEFR ${cefrLevel}:**
                          - Предложение должно быть **максимально простым и понятным** для изучающих английский язык на уровне CEFR **${cefrLevel}**.
                          - **Используй словарный запас и грамматические конструкции**, соответствующие уровню **${cefrLevel}** для создания реалистичного примера.
                          - **Избегай** усложнений, нетипичных для реальной речи на данном уровне.

                        4. **Простота и Понятность:**
                          - Предложение должно быть **очень легким для понимания**, как предложения, которые вы могли бы услышать или прочитать в **обычном, неадаптированном английском языке**.
                          - Используй **простую структуру предложения** и **обычную лексику**.
                          - Стремись к **максимальной ясности и естественности**, даже если это означает пожертвовать некоторой "оригинальностью" в пользу "реалистичности".

                        5. **Использование слова в естественном контексте:**
                          - Предложение должно **логично и уместно использовать слово** "${word}" в соответствии с его частью речи "${partOfSpeech}" и определением "${russianTranslation}" **в контексте, который звучит реалистично**.

                        6. **Краткость:**
                          - Предложение должно быть **достаточно кратким**, чтобы быть легко запоминающимся и  представлять собой хороший, лаконичный пример реального использования.

                        **Требования к русскому переводу:**

                         1. **Максимальная стилистическая естественность и плавность звучания**:
                           - Русский перевод должен звучать **максимально естественно и плавно на русском языке**, как будто это изначально предложение на русском, а не перевод.
                           - **Избегай любых конструкций, которые звучат неестественно,  "переводно" или "машинно" на русском.**
                           - **Стремись к  *безупречной стилистической естественности и беглости*  русского текста.**

                         2. **Минимизация использования скобок**:
                           - **Критически важно:  Максимально минимизируй использование скобок в русском переводе.**
                           - **Используй скобки *только в крайних случаях*, когда это абсолютно необходимо для:**
                             * **Стилистической ясности**, если без скобок смысл на русском может быть неясен или двусмыслен (но старайся избегать таких ситуаций в принципе, подбирая формулировки, изначально ясные на русском).
                             * **Добавления слов, отсутствующих в английском оригинале, но *необходимых для естественного и плавного звучания на русском языке* (например,  как мы решили использовать "(выступления)" в предыдущем примере, и только если это действительно улучшает естественность).**
                             * **Кратких,  очень лаконичных стилистических или эмоциональных уточнений,  которые *действительно* уместны в скобках в русском языке,  и *не перегружают* текст.**
                           - **В *подавляющем большинстве* случаев русский перевод должен быть *без скобок*.**

                         3. **Избегать излишней дословности и "подсказок"**:
                           - **Не стремись к излишней дословности и "пословной" точности перевода, если это вредит стилистической естественности русского языка.**
                           - **Особенно  *избегай добавлять в скобки элементы, которые являются лишь пояснениями или "подсказками" для изучающего язык, но не являются органичной частью естественного русского предложения*.**  Например, не нужно заключать в скобки подлежащее "(Я)",  только потому что оно явно не выражено в английском, если в русском языке оно и так понятно из контекста или личных окончаний глагола.

                         4. **Понятность времени (через естественный русский язык)**:
                           - Русский перевод должен **явно и понятно передавать время** английского предложения, но **добивайся этого *естественными средствами русского языка*, без искусственных добавлений в скобках, если это возможно.**
                           - Время должно быть понятно из *общего контекста фразы,  выбора временных форм глаголов в русском языке, или использования *естественных* для русского языка временных наречий (если они уместны и не делают фразу громоздкой),  а не через скобки.**
                           - **Если необходимо явно указать время,  старайся интегрировать указание времени *органично в структуру русского предложения*,  а не "выносить" его в скобки.**

                        **Примеры предложений, которые *КАТЕГОРИЧЕСКИ НЕДОПУСТИМЫ* из-за избытка скобок (ИЗБЕГАЙТЕ ПОДОБНЫХ, СТРЕМИТЕСЬ К ПЕРЕВОДАМ БЕЗ СКОБОК):**
                        - Английское предложение: "I see her, the dancer, on TV sometimes."
                          {
                            "russianTranslation": "(Я) иногда вижу её, (эту) танцовщицу, по телевизору."  **<--  КАТАСТРОФИЧЕСКИ ПЛОХО из-за избытка скобок!**
                          }
                          (Этот перевод **звучит совершенно неестественно на русском языке из-за чрезмерного использования скобок.**  Он создает впечатление "машинного" перевода и  *абсолютно не подходит* как пример естественной русской речи.)

                        **Примеры предложений, которые *более реалистичны и желательны* (СТРЕМИСЬ К ПОДОБНЫМ, МИНИМУМ СКОБОК):**
                        - Английское предложение: "I see her, the dancer, on TV sometimes."
                          {
                            "russianTranslation": "Я иногда вижу ее, танцовщицу, по телевизору." **<--  ХОРОШО,  скобки отсутствуют, звучит гораздо естественнее.**
                          }
                          {
                             "russianTranslation": "Иногда я вижу ее, эту танцовщицу, по телевизору." **<--  ТОЖЕ ПРИЕМЛЕМО, хотя все еще немного формально из-за "эту", но уже лучше, чем с избытком скобок.**
                          }
                          {
                            "russianTranslation": "Иногда вижу ее по телевизору, эту танцовщицу." **<--  ЕЩЕ ЛУЧШЕ, перестановка слов делает фразу более плавной и убирает необходимость в скобках,  стилистически более предпочтительный вариант.**
                          }
                          {
                            "russianTranslation": "Иногда я вижу ее по телевизору, танцовщицу." **<--  ОТЛИЧНО,  еще более кратко и естественно,  без скобок и без избыточных уточнений,  очень хороший вариант для естественной русской речи.**
                          }


                        **Формат ответа:**
                        Пожалуйста, предоставь ответ в формате JSON (не массив), содержащем два поля: "englishSentence" и "russianTranslation".

                        Пример JSON ответа:
                        {
                          "englishSentence": "...",
                          "russianTranslation": "..."
                        }
        `;

    try {
      const completion = await this.openAIService.createChatCompletion<{
        englishSentence: string;
        russianTranslation: string;
      }>(prompt);

      return completion;
    } catch (error) {
      console.error(
        'Error creating chat completion for word and grammar topic:',
        error,
      );
      throw error;
    }
  }
}
