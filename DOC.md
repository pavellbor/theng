# Спецификация проекта: Система для изучения английского языка

## Общее описание
Данный проект представляет собой бэкенд приложение для изучения английского языка с русским в качестве родного языка. Система построена на основе NestJS, использует Prisma ORM для работы с PostgreSQL и интегрирует OpenAI для генерации контента и проверки переводов.

Ключевая особенность MVP — прямой подход к обучению через практику перевода предложений с использованием системы интервального повторения. Пользователь сразу после входа получает персонализированное предложение для перевода, соответствующее его уровню и текущему прогрессу обучения.

## Технический стек

### Бэкенд
- **Фреймворк**: NestJS
- **ORM**: Prisma
- **База данных**: PostgreSQL
- **Аутентификация**: JWT (jsonwebtoken)
- **Валидация**: class-validator, class-transformer
- **Документация API**: Swagger (NestJS Swagger)
- **Хеширование паролей**: bcrypt
- **Логирование**: Winston
- **Тестирование**: Jest, Supertest

### Внешние API
- **Генерация текста**: OpenAI API (GPT-3.5/4)
- **Email**: NodeMailer (для восстановления пароля)

### Инфраструктура
- **Контейнеризация**: Docker
- **Кэширование**: Redis (опционально)
- **CI/CD**: GitHub Actions
- **Мониторинг**: Prometheus + Grafana (опционально)

## Модели данных

### User (Пользователь)
- id: Int (первичный ключ)
- email: String (уникальный)
- name: String (опционально)
- password: String (хешированный)
- cefrLevel: CEFRLevel (уровень владения языком, по умолчанию A1)
- role: Role (роль пользователя, по умолчанию USER)
- streak: Int (серия дней активности, по умолчанию 0)
- lastActive: DateTime (дата последней активности)
- dailyGoal: Int (цель по упражнениям в день, по умолчанию 10)
- createdAt: DateTime
- updatedAt: DateTime
- Связи с прогрессом обучения (слова, грамматика, предложения)

### Word (Слово)
- id: Int (первичный ключ)
- word: String
- definition: String (определение)
- russianTranslation: String (перевод слова на русский)
- partOfSpeech: PartOfSpeech (часть речи)
- cefrLevel: CEFRLevel (уровень сложности)
- contextExamples: String[] (примеры использования)
- createdAt: DateTime
- updatedAt: DateTime
- sentences: Sentence[] (связь с предложениями)
- userWordProgress: UserWordProgress[] (связь с прогрессом пользователей)

### GrammarTopic (Грамматическая тема)
- id: Int (первичный ключ)
- name: String (уникальный)
- description: String
- explanationText: String (подробное объяснение темы)
- exampleSentences: String[] (примеры для иллюстрации)
- cefrLevel: CEFRLevel (уровень сложности)
- category: GrammarTopicCategory (категория)
- createdAt: DateTime
- updatedAt: DateTime
- Связь с предложениями и прогрессом пользователя

### Sentence (Предложение)
- id: Int (первичный ключ)
- englishSentence: String (предложение на английском)
- russianTranslation: String (перевод на русский)
- cefrLevel: CEFRLevel (уровень сложности)
- grammarTopicId: Int (связь с грамматической темой)
- wordId: Int (связь со словом)
- createdAt: DateTime
- updatedAt: DateTime
- Связь с прогрессом пользователя

### UserWordProgress (Прогресс пользователя по словам)
- id: Int (первичный ключ)
- userId: Int (связь с пользователем)
- wordId: Int (связь со словом)
- createdAt: DateTime
- lastStudied: DateTime (опционально)
- nextReviewDate: DateTime (опционально)
- reviewCount: Int (количество повторений)
- successCount: Int (количество успешных ответов)
- failureCount: Int (количество неудачных ответов)
- mastery: Float (уровень освоения от 0 до 1)

### UserGrammarTopicProgress (Прогресс пользователя по грамматике)
- id: Int (первичный ключ)
- userId: Int (связь с пользователем)
- grammarTopicId: Int (связь с грамматической темой)
- createdAt: DateTime
- lastStudied: DateTime (опционально)
- nextReviewDate: DateTime (опционально)
- reviewCount: Int (количество повторений)
- successCount: Int (количество успешных применений)
- failureCount: Int (количество ошибок)
- mastery: Float (уровень освоения от 0 до 1)

### UserSentenceProgress (Прогресс пользователя по предложениям)
- id: Int (первичный ключ)
- userId: Int (связь с пользователем)
- sentenceId: Int (связь с предложением)
- createdAt: DateTime
- lastStudied: DateTime (опционально)
- isCorrect: Boolean (флаг правильности перевода)
- attemptsCount: Int (количество попыток)
- lastTranslation: String (последний перевод пользователя)
- wordCorrect: Boolean (правильность использования ключевого слова)
- grammarCorrect: Boolean (правильность применения грамматики)

### LearningSession (Сессия обучения)
- id: Int (первичный ключ)
- userId: Int (связь с пользователем)
- user: User (связь с моделью User)
- startedAt: DateTime (время начала сессии)
- endedAt: DateTime? (время окончания сессии, опционально)
- exercisesCompleted: Int (количество выполненных упражнений)
- correctAnswers: Int (количество правильных ответов)
- incorrectAnswers: Int (количество неправильных ответов)
- practiceWords: Int[] (ID слов, отработанных в сессии)
- practiceGrammar: Int[] (ID грамматических тем, отработанных в сессии)

## Перечисления (Enums)

### CEFRLevel (Уровни владения языком)
- A1
- A2
- B1
- B2
- C1Plus (C1+)

### PartOfSpeech (Части речи)
- noun (существительное)
- verb (глагол)
- adjective (прилагательное)
- adverb (наречие)
- pronoun (местоимение)
- preposition (предлог)
- conjunction (союз)
- interjection (междометие)
- determiner (определитель)
- auxiliaryVerb (вспомогательный глагол)
- modalVerb (модальный глагол)
- article (артикль)
- numeral (числительное)
- participle (причастие)
- gerund (герундий)
- infinitiveMarker

### GrammarTopicCategory (Категории грамматических тем)
- VerbsAndTenses (Глаголы и времена)
- ClausesAndQuestions (Предложения и вопросы)
- ModalVerbs (Модальные глаголы)
- NonfiniteVerbs (Нефинитные формы глагола)
- Nouns (Существительные)
- Adjectives (Прилагательные)
- Adverbs (Наречия)
- OtherPartsOfSpeech (Другие части речи)

### Role (Роли пользователей)
- USER
- ADMIN
- MODERATOR

## Основные модули

### Auth (Аутентификация)
- Регистрация пользователей: Создание новых учетных записей
- Авторизация: Генерация JWT токенов
- Защита маршрутов: Guards для защиты маршрутов
- Управление ролями: Декораторы для ограничения доступа по ролям

### Users (Пользователи)
- CRUD операции для управления пользователями
- Получение информации о текущем пользователе
- Отслеживание активности пользователя (серия дней, последний вход)

### Words (Слова)
- CRUD операции для управления словами в системе
- API для получения контекстных примеров и переводов

### GrammarTopics (Грамматические темы)
- CRUD операции для управления грамматическими темами
- API для получения объяснений и примеров

### Sentences (Предложения)
- CRUD операции для управления предложениями
- Связывание предложений со словами и грамматическими темами

### Exercises (Упражнения)
- Генерация новых упражнений на основе уровня CEFR пользователя
- Проверка переводов, выполненных пользователем
- Интеграция с OpenAI для генерации предложений и проверки переводов
- Возвращение предложений с соответствующими бейджами и пояснениями

### UserProgress (Прогресс пользователя)
- Отслеживание прогресса пользователя по словам, грамматике и предложениям
- Реализация системы интервального повторения (spaced repetition)
- Определение материала для повторения на основе расписания
- Расчет и обновление показателей mastery

### OpenAI (Интеграция с OpenAI)
- Генерация новых предложений на основе слов и грамматических тем
- Проверка переводов пользователя с предоставлением обратной связи

### Sessions (Сессии обучения)
- Отслеживание учебных сессий пользователя
- Сбор статистики для анализа и улучшения обучения

## Ключевые функции

### Основной пользовательский сценарий (MVP)
Пользователь после регистрации и авторизации сразу видит предложение для практики, которое сгенерировано для него персонально на основе его уровня и алгоритма интервальных повторений. Если предложение использует новое слово и/или грамматику, рядом с предложением располагаются соответствующие бейджи с подробным описанием этих сущностей. Пользователь переводит предложение и получает фидбек, на бэкенде происходит обновление его прогресса. Далее пользователю генерируется новое предложение, и цикл повторяется.

### Система интервального повторения
Система использует алгоритм интервального повторения, где интервалы увеличиваются по мере успешного запоминания:

- После первого повторения - через 1 день
- После второго - через 3 дня
- После третьего - через 7 дней
- После четвертого - через 16 дней
- После пятого - через 30 дней
- После шестого - через 60 дней
- После седьмого - через 180 дней
- После восьмого - через 365 дней

При ошибке интервал сокращается на основе анализа типа ошибки:
- При серьёзных ошибках (неверное ключевое слово и грамматическая тема) - возврат к 1 дню
- При частичных ошибках (например, только в грамматике) - интервал сокращается наполовину от текущего 
- При стилистических ошибках (смысл передан верно) - интервал сокращается незначительно

Этот подход обеспечивает более гибкую адаптацию к особенностям обучения каждого пользователя.

### Генерация предложений
Система использует OpenAI для создания предложений, которые:

- Демонстрируют заданное слово в естественном контексте
- Иллюстрируют определенную грамматическую тему
- Соответствуют уровню CEFR пользователя
- Имеют точный перевод на русский язык

### Проверка переводов
Система анализирует переводы пользователя на нескольких уровнях:

- Правильность использования ключевого слова
- Корректное применение грамматической темы
- Общая точность и естественность перевода

Пользователь получает подробную обратную связь на русском языке по каждому из этих аспектов.

## API Endpoints

### Auth
- POST /auth/register - Регистрация нового пользователя
- POST /auth/login - Авторизация пользователя

### Users
- GET /users/me - Информация о текущем пользователе
- GET /users - Список всех пользователей
- GET /users/:id - Детали конкретного пользователя
- POST /users - Создание пользователя
- PATCH /users/:id - Обновление пользователя
- DELETE /users/:id - Удаление пользователя

### Words
- GET /words - Список всех слов (с фильтрацией по cefrLevel, partOfSpeech)
- GET /words/:id - Детали конкретного слова
- POST /words - Добавление нового слова (только для ADMIN, MODERATOR)
- PATCH /words/:id - Обновление слова (только для ADMIN, MODERATOR)
- DELETE /words/:id - Удаление слова (только для ADMIN)

### Grammar Topics
- GET /grammar-topics - Список всех грамматических тем (с фильтрацией по cefrLevel, category)
- GET /grammar-topics/:id - Детали конкретной грамматической темы
- POST /grammar-topics - Добавление новой грамматической темы (только для ADMIN, MODERATOR)
- PATCH /grammar-topics/:id - Обновление грамматической темы (только для ADMIN, MODERATOR)
- DELETE /grammar-topics/:id - Удаление грамматической темы (только для ADMIN)

### Sentences
- GET /sentences - Список всех предложений (с фильтрацией по cefrLevel, grammarTopicId, wordId)
- GET /sentences/:id - Детали конкретного предложения
- POST /sentences - Добавление нового предложения (только для ADMIN, MODERATOR)
- PATCH /sentences/:id - Обновление предложения (только для ADMIN, MODERATOR)
- DELETE /sentences/:id - Удаление предложения (только для ADMIN)

### Exercises
- GET /exercises/next - Получение следующего упражнения (с бейджами для нового материала)
- POST /exercises/check - Проверка перевода пользователя
- POST /exercises/skip - Пропуск текущего упражнения (без штрафа за ошибку)
- GET /exercises/history - История выполненных упражнений
- POST /exercises/start-session - Начало новой учебной сессии
- POST /exercises/end-session - Завершение учебной сессии

### User Progress
- GET /user-progress/words - Прогресс пользователя по словам
- GET /user-progress/grammar - Прогресс пользователя по грамматическим темам
- GET /user-progress/overview - Общий обзор прогресса обучения

### Statistics
- GET /statistics/daily - Получение статистики за текущий день
- GET /statistics/weekly - Получение статистики за текущую неделю
- GET /statistics/monthly - Получение статистики за текущий месяц
- GET /statistics/streak - Информация о текущей серии дней обучения
- GET /statistics/progress - Общий прогресс обучения пользователя

## Безопасность
- Аутентификация через JWT с ограниченным сроком действия токенов (24 часа)
- Хеширование паролей с помощью bcrypt с достаточным количеством раундов (10+)
- Разграничение доступа на основе ролей пользователей (USER, MODERATOR, ADMIN)
- Валидация входных данных с использованием class-validator и class-transformer
- Защита от основных уязвимостей веб-приложений (OWASP Top 10)
- Rate limiting для предотвращения атак перебором и DDoS
- Безопасные заголовки HTTP (HSTS, CSP, X-Content-Type-Options и т.д.)
- Логирование попыток несанкционированного доступа

## Документация API
Система использует Swagger для автоматического создания документации API:
- Доступ к документации через /api
- Описание всех доступных эндпоинтов
- Схемы запросов и ответов

## Дополнительные особенности
- Автоматическая генерация упражнений в соответствии с уровнем пользователя
- Интеллектуальный анализ переводов с обратной связью на русском языке
- Адаптивная система интервального повторения
- Выбор материала для изучения на основе текущего прогресса пользователя
- Индикатор дневного прогресса (количество выполненных упражнений)
- Отслеживание серии дней обучения (streak)

## Улучшения для будущих версий (пост-MVP)

### Расширение учебного опыта
- Вариации в формате заданий (множественный выбор, заполнение пропусков, аудирование)
- Тематические категории для контекстного обучения (бизнес, путешествия, технологии)
- Персонализированные учебные пути на основе интересов пользователя
- Чтение и понимание текстов с упражнениями на основе содержания

### Геймификация и мотивация
- Система достижений и наград для повышения мотивации
- Виртуальная валюта и система поощрений за регулярные занятия
- Уровни мастерства для каждой категории (новичок, продвинутый, эксперт)
- Еженедельные вызовы и цели для поддержания вовлеченности

### Социальные элементы
- Лидерборды по разным категориям (серии дней, количество изученных слов)
- Возможность добавлять друзей и следить за их прогрессом
- Групповые вызовы и соревнования
- Обмен достижениями в социальных сетях

### Аналитика и улучшение обучения
- Подробная визуализация прогресса по темам и уровням
- Идентификация слабых мест и персонализированные рекомендации
- Адаптивная настройка сложности на основе производительности
- Прогнозирование готовности к повышению уровня CEFR

### Технические улучшения
- Офлайн режим для обучения без доступа к интернету
- Мобильные приложения (iOS, Android) с синхронизацией прогресса
- Интеграция с голосовыми помощниками для практики произношения
- Расширенные API для интеграции с другими образовательными платформами

### Административные функции
- Панель управления для администраторов с подробной аналитикой
- Система мониторинга использования OpenAI API
- Инструменты для массового импорта учебных материалов
- Система модерации пользовательского контента

Эта спецификация представляет собой комплексный обзор проекта, начиная с MVP с фокусом на непосредственное обучение через практику перевода предложений и систему интервального повторения, и заканчивая планируемыми улучшениями для будущих версий.